function createUrl(e){var t=CryptoJS.AES.encrypt(JSON.stringify(e),secret).toString();window.location.href="#?input_state="+t}function getUrl(){var e=window.location.href.split("#?input_state=");if(e.length>1){var t=CryptoJS.AES.decrypt(e[1],secret);decryptedData=JSON.parse(t.toString(CryptoJS.enc.Utf8)),window.storageService.setItem("appname",decryptedData.appname);var r;try{r=JSON.stringify(decryptedData.selectedType)}catch(n){r=JSON.stringify([])}r=null==r?[]:r,window.storageService.setItem("types",r)}}function convertToUrl(e){var t=CryptoJS.AES.encrypt(JSON.stringify(input_state),secret).toString(),r="";return r="gh-pages"==e?"appbaseio.github.io/dejaVu/live/#?input_state="+t:"appbaseio"==e?"https://appbase.io/scalr/"+input_state.appname+"/browser/#?input_state="+t:window.location.protocol+"//"+window.location.host+"#?input_state="+t}function getDataSize(){var e=20,t=$(window).height()-150,r=51,n=Math.ceil(t/r),a=n<e?e:n;return a}function init(){appbaseRef=new Appbase({url:URL,appname:APPNAME,username:USERNAME,password:PASSWORD})}var secret="dejvu",decryptedData={};getUrl();var keyGen=function(e,t){return e._type+String(e._id)+String(t)},rowKeyGen=function(e){return e._id+e._type},dropdownKeyGen=function(e){return"dropdown"+e},filterKeyGen=function(e,t){return e=e.replace(/\s/,""),t=t.replace(/\s/,""),"filter"+e+t},revertTransition=function(e){e&&(e.style.background="white")},updateTransition=function(e){var t=document.getElementById(e);t&&(t.style.background="#F5E79E"),setTimeout(this.revertTransition.bind(null,t),1e3)},deleteTransition=function(e){var t=document.getElementById(e);t&&(t.style.background="#FF5B5B"),setTimeout(this.revertTransition.bind(null,t),1e3)},newTransition=function(e){var t=document.getElementById(e);t&&(t.style.background="#B6EF7E"),setTimeout(this.revertTransition.bind(null,t),1e3)};const DATA_SIZE=getDataSize();var APPNAME,USERNAME,PASSWORD,URL,OperationFlag,APPURL,input_state,appbaseRef,getMapFlag=!1,appAuth=!0,exportJsonData=[],counterStream,streamRef,browse_url=window.location.href,flag_url="true"===browse_url.split("?default=")[1]||browse_url.split("?default=")[1]===!0;if(flag_url&&!decryptedData.hasOwnProperty("url")||(config={url:window.storageService.getItem("esurl"),appname:window.storageService.getItem("appname")}),APPNAME=config.appname,URL=config.url)try{var urlsplit=URL.split(":"),pwsplit=urlsplit[2].split("@");USERNAME=urlsplit[1].replace("//",""),PASSWORD=pwsplit[0];var httpPrefix=URL.split("://");HOST=URL.indexOf("@")!==-1?httpPrefix[0]+"://"+pwsplit[1]:URL,OperationFlag=!1,APPURL=URL+"/"+APPNAME,input_state={},init()}catch(e){console.log(e);var HOST=document.URL.split("/_plugin/")[0];OperationFlag=!1,APPURL=URL+"/"+APPNAME,USERNAME="test",PASSWORD="test",input_state={},init()}var sdata={},headers=["_type","_id"],esTypes=[],subsetESTypes=[],feed=function(){function e(e,t){appbaseRef.search({type:e,body:{query:{match_all:{}}}}).on("data",function(e){t(e.hits.total)}),"undefined"!=typeof counterStream&&counterStream.stop(),counterStream=appbaseRef.searchStream({type:e,body:{query:{match_all:{}}}}).on("data",function(e){e._updated?console.log("Updated"):e._deleted?t(0,!0,"delete"):t(0,!0,"index")}).on("error",function(e){console.log("caught a stream error",e)})}function t(){setTimeout(function(){OperationFlag=!1},500)}function r(e,t,r,n){$.ajax({type:"POST",beforeSend:function(e){e.setRequestHeader("Authorization","Basic "+btoa(USERNAME+":"+PASSWORD))},url:e,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(t),xhrFields:{withCredentials:!0},success:function(e){r(e)},error:function(){n&&n()}})}function n(e,t,n,a){if(null!==e){var o={query:{match_all:{}}};a=a?a:o;var i=e.join(","),s=HOST+"/"+APPNAME+"/"+i+"/_search?preference=abcxyz&from="+t+"&size="+DATA_SIZE;r(s,a,function(e){n(e.hits.hits)})}}function a(n,a,o,i){if(null!==n){var s={query:{match_all:{}}};o=o?o:s;var u=Object.keys(sdata).length;sdata={};var c=n.join(","),l=HOST+"/"+APPNAME+"/"+c+"/_search?preference=abcxyz&from=0&size="+Math.max(u,DATA_SIZE);r(l,o,function(e){try{var r,n,o;return 0===e.hits.hits.length?(r=null,n=!1,o=0):(r=e.hits.hits,n=!1,o=e.hits.total),t(),a(r,n,o)}catch(i){t(),console.log(i)}},function(){t()}),e(n,i),"undefined"!=typeof streamRef&&streamRef.stop(),streamRef=appbaseRef.searchStream({type:n,body:o}).on("data",function(e){e.hasOwnProperty("_updated")&&delete e._updated,a(e,!0)}).on("error",function(e){console.log("caught a stream error",e)})}}return{countStream:function(t,r){e(t,r)},getData:function(e,t,r){a(e,t,!1,r)},deleteData:function(e,t){var r={};for(var n in sdata)sdata[n]._type!==e&&(r[n]=sdata[n]);sdata=r,t(sdata)},paginateData:function(e,t,r){n(subsetESTypes,Object.keys(sdata).length,t,null!==r?r:null)},getTypes:function(e){if("undefined"!=typeof APPNAME)this.filterType().done(function(t){var r=t.aggregations.count_by_type.buckets,n=r.filter(function(e){return e.doc_count>0});if(n=n.map(function(e){return e.key}),n.length){if(JSON.stringify(esTypes.sort())!==JSON.stringify(n.sort())&&(esTypes=n.slice(),null!==e))return e(n)}else if(null!==e)return e(n)}).error(function(e){console.log(e),clearInterval(streamingInterval),console.log("error in retrieving types: ",e)});else{var t=this;setTimeout(function(){t.getTypes(e)},1e3)}},indexData:function(e,t,r){var n=this;if("index"===t)appbaseRef.index(e).on("data",function(e){return esTypes.indexOf(e._type)!==-1?r():void n.getTypes(function(e){if(r)return r(e)})});else{var a=e.body;e.body={doc:a},console.log(e),appbaseRef.update(e).on("data",function(){if(r)return r()})}},deleteRecord:function(e,t){function r(t,r){e.forEach(function(e){"undefined"!=typeof t[r]&&t[r]._type===e._type&&t[r]._id===e._id&&delete t[r]})}var n=e.map(function(e){return{"delete":e}});console.log(n),appbaseRef.bulk({body:n}).on("data",function(e){for(var n in sdata)sdata.hasOwnProperty(n)&&r(sdata,n);t(sdata)})},getSingleDoc:function(e,t){appbaseRef.search({type:e,from:0,size:1,body:{query:{match_all:{}}}}).on("data",function(e){t(e)})},getMapping:function(){var e=HOST+"/"+APPNAME+"/_mapping";return $.ajax({type:"GET",beforeSend:function(e){e.setRequestHeader("Authorization","Basic "+btoa(USERNAME+":"+PASSWORD))},url:e,xhrFields:{withCredentials:!0}})},applyQuery:function(e,t){return $.ajax({type:"POST",beforeSend:function(e){e.setRequestHeader("Authorization","Basic "+btoa(USERNAME+":"+PASSWORD))},url:e,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(t),xhrFields:{withCredentials:!0}})},applyGetQuery:function(e){return $.ajax({type:"GET",beforeSend:function(t){t.setRequestHeader("Authorization","Basic "+btoa(e.USERNAME+":"+e.PASSWORD))},url:e.URL,xhrFields:{withCredentials:!0}})},filterType:function(){var e=HOST+"/"+APPNAME+"/_search?search_type=count",t={aggs:{count_by_type:{terms:{field:"_type"}}}};return this.applyQuery(e,t)},scrollapi:function(e,t,r,n){var a=e.join(","),o=HOST+"/"+APPNAME+"/"+a+"/_search?scroll=5m",i=HOST+"/_search/scroll?scroll=5m&scroll_id="+n,s=r?i:o;return this.applyQuery(s,t)},testQuery:function(e,t){return appbaseRef.search({type:e,from:0,size:0,body:t})},getTotalRecord:function(){return appbaseRef.search({from:0,size:0,type:[],body:{query:{match_all:{}}}})},getIndices:function(e){var t=this.filterUrl(e);return t?(t.URL+="/_stats/indices",this.applyGetQuery(t)):null},checkIndex:function(e,t){this.executeIndexOperation(e,t)},createIndex:function(e,t){this.executeIndexOperation(e,t)},executeIndexOperation:function(e,t){var r=this.filterUrl(e);return r?(r.URL+="/"+t,this.applyGetQuery(r)):null},filterUrl:function(e){if(e){var t={USERNAME:"test",PASSWORD:"test",URL:e},r=e.split(":"),n=r[2].split("@");try{t.USERNAME=r[1].replace("//",""),t.PASSWORD=n[0];var a=e.split("://");t.URL=e.indexOf("@")!==-1?a[0]+"://"+n[1]:e}catch(o){console.log(o)}return t}return null},filterQuery:function(e,t,r,n,o,i,s){var u=this.createFilterQuery(e,t,r,n,o);a(n,i,u,s)},createFilterQuery:function(e,t,r,n,a){function o(){return u=a?"match":"term",r.forEach(function(e){var r={};r[t]=e.trim();var n={};n[u]=r,l.push(n)}),l}function i(e){return p={},p[t]={},p[t][e]=r[0],c={query:{range:p}},p}function s(t){var r={minimum_should_match:1},n="has"===e?"must":"must_not";return r[n]=t,{query:{bool:r}}}var u,c={},l=[];switch(e){case"has":case"has not":l=o(),c=s(l);break;case"search":var p={};p[t]=r[0].trim(),c={query:{match:p}};break;case"greater than":p=i("gte");break;case"less than":p=i("lte");break;case"range":var d=r[0].split("@");p={},p[t]={},p[t]={gte:d[0],lte:d[1]},c={query:{range:p}};break;case"term":p={},p[t]=r[0].trim(),c={query:{term:p}}}return c}}}(),help={flatten:function(e){var t=[];if(null!=e)for(var r in e._source)e[r]=e._source[r],"string"!=typeof e[r]&&"number"!=typeof e[r]&&t.push(r);return e.json=e._source,e._source&&delete e._source,e._index&&delete e._index,e._score&&delete e._score,{data:e,fields:t}},getOrder:function(e){var t=!1;return e==this.currentItem?this.currentOrder||(t=!0):this.currentItem=e,this.currentOrder=t,t},sortIt:function(e,t,r){var n=this,a=_.filter(e,function(e){return"undefined"!=typeof e[t]}),o=_.filter(e,function(e){return"undefined"==typeof e[t]}),i=a.sort(n.dynamicSort(t,r)),i=$.merge(i,o);return i},dynamicSort:function(e,t){return function(r,n){if(sortOrder=t?-1:1,"json"==e&&(e="_type"),isNaN(r[e]))var a=r[e].toLowerCase()<n[e].toLowerCase()?-1:r[e].toLowerCase()>n[e].toLowerCase()?1:0;else var a=r[e]<n[e]?-1:r[e]>n[e]?1:0;return a*sortOrder}},exportData:function(){var e=$("#addObjectForm_export").serializeArray(),t={type:[],username:PROFILE.name};return e.forEach(function(e){"type"==e.name?t.type.push(e.value):"body"==e.name&&(t.query=JSON.parse(e.value))}),$("#exportBtn").addClass("loading").attr("disabled",!0),t},selectRecord:function(e,t,r,n,a,o){var n={};return selectedRows=[],$(".rowSelectionCheckbox:checked").each(function(t,r){var a={_id:$(r).attr("value"),_type:$(r).data("type")};selectedRows.push(a),0===t&&(n=$(r).data("row").json,e.id=a._id,e.type=a._type)}),e.active=!!selectedRows.length,e.selectedRows=selectedRows,{actionOnRecord:e}},removeSelection:function(e){return e.active=!1,e.id=null,e.type=null,e.selectedRows=[],{actionOnRecord:e}},selectAll:function(e,t,r){return e?(t.selectedRows=[],_.each(r,function(e){var r={_id:e._id,_type:e._type};t.selectedRows.push(r)})):t.selectedRows=this.removeSelection(t),console.log(t.selectedRows),t},setCodeMirror:function(e){var t={lineNumbers:!0,mode:"javascript",autoCloseBrackets:!0,matchBrackets:!0,showCursorWhenSelecting:!0,tabSize:2,extraKeys:{"Ctrl-Q":function(e){e.foldCode(e.getCursor())}},foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"]};return CodeMirror.fromTextArea(document.getElementById(e),t)}};